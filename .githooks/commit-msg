#!/bin/bash
# Hook commit-msg para PetCare DBA Admin
# Valida e melhora mensagens de commit seguindo padrÃµes de qualidade

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Arquivo da mensagem de commit
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo -e "${BLUE}ğŸ“ Validando mensagem de commit...${NC}"

# FunÃ§Ã£o para imprimir cabeÃ§alho de seÃ§Ã£o
print_section() {
    echo -e "\n${BLUE}â•â•â• $1 â•â•â•${NC}"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. VERIFICAÃ‡Ã•ES BÃSICAS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "VerificaÃ§Ãµes BÃ¡sicas"

# Ignorar commits de merge
if echo "$COMMIT_MSG" | grep -q "^Merge "; then
    echo -e "${GREEN}âœ… Commit de merge detectado - pulando validaÃ§Ã£o${NC}"
    exit 0
fi

# Ignorar commits de revert
if echo "$COMMIT_MSG" | grep -q "^Revert "; then
    echo -e "${GREEN}âœ… Commit de revert detectado - pulando validaÃ§Ã£o${NC}"
    exit 0
fi

# Ignorar commits automÃ¡ticos do GitHub
if echo "$COMMIT_MSG" | grep -qE "^(Initial commit|Create|Update|Delete).*\.md$"; then
    echo -e "${GREEN}âœ… Commit automÃ¡tico detectado - pulando validaÃ§Ã£o${NC}"
    exit 0
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. VALIDAÃ‡ÃƒO DE TAMANHO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "ValidaÃ§Ã£o de Tamanho"

# Obter primeira linha (subject)
SUBJECT=$(echo "$COMMIT_MSG" | head -n1)
SUBJECT_LENGTH=${#SUBJECT}

# Verificar tamanho mÃ­nimo
if [ $SUBJECT_LENGTH -lt 10 ]; then
    echo -e "${RED}âŒ Mensagem muito curta (${SUBJECT_LENGTH} caracteres)${NC}"
    echo -e "${BLUE}ğŸ’¡ Use pelo menos 10 caracteres para descrever a mudanÃ§a${NC}"
    echo -e "${YELLOW}Exemplo: fix(auth): corrigir validaÃ§Ã£o de login${NC}"
    exit 1
fi

# Verificar tamanho mÃ¡ximo
if [ $SUBJECT_LENGTH -gt 72 ]; then
    echo -e "${YELLOW}âš ï¸  Mensagem longa (${SUBJECT_LENGTH} caracteres)${NC}"
    echo -e "${BLUE}ğŸ’¡ Tente manter abaixo de 72 caracteres no tÃ­tulo${NC}"
    echo -e "${YELLOW}Mensagem atual: ${SUBJECT}${NC}"
    
    # NÃ£o bloquear, apenas avisar
    read -p "Continuar mesmo assim? [Y/n] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        echo -e "${BLUE}Edite a mensagem e tente novamente${NC}"
        exit 1
    fi
fi

echo -e "  ${GREEN}âœ… Tamanho: ${SUBJECT_LENGTH} caracteres${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. VALIDAÃ‡ÃƒO DE FORMATO CONVENTIONAL COMMITS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "ValidaÃ§Ã£o de Formato"

# Tipos vÃ¡lidos de commit
VALID_TYPES="feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert"

# Escopos vÃ¡lidos para o projeto
VALID_SCOPES="auth|database|ui|api|config|docs|test|deploy|monitoring|backup|security|performance|analytics|reports"

# Verificar formato bÃ¡sico
if echo "$SUBJECT" | grep -qE "^(${VALID_TYPES})(\(.*\))?: .+"; then
    # Extrair componentes
    TYPE=$(echo "$SUBJECT" | sed -E "s/^(${VALID_TYPES})(\(.*\))?: .*/\1/")
    SCOPE=$(echo "$SUBJECT" | sed -E "s/^${VALID_TYPES}\(([^)]*)\): .*/\1/" | grep -v "^${SUBJECT}$" || echo "")
    DESCRIPTION=$(echo "$SUBJECT" | sed -E "s/^(${VALID_TYPES})(\([^)]*\))?: (.*)/\3/")
    
    echo -e "  ${GREEN}âœ… Formato vÃ¡lido detectado${NC}"
    echo "    Tipo: $TYPE"
    [ -n "$SCOPE" ] && echo "    Escopo: $SCOPE"
    echo "    DescriÃ§Ã£o: $DESCRIPTION"
    
    # Validar escopo se presente
    if [ -n "$SCOPE" ] && ! echo "$SCOPE" | grep -qE "^(${VALID_SCOPES})$"; then
        echo -e "  ${YELLOW}âš ï¸  Escopo '$SCOPE' nÃ£o reconhecido${NC}"
        echo -e "  ${BLUE}ğŸ’¡ Escopos sugeridos: ${VALID_SCOPES//|/, }${NC}"
    fi
    
else
    echo -e "${YELLOW}âš ï¸  Formato nÃ£o convencional detectado${NC}"
    echo -e "${BLUE}ğŸ’¡ Formato recomendado: tipo(escopo): descriÃ§Ã£o${NC}"
    echo ""
    echo -e "${BLUE}Tipos vÃ¡lidos:${NC}"
    echo "  â€¢ feat: nova funcionalidade"
    echo "  â€¢ fix: correÃ§Ã£o de bug"
    echo "  â€¢ docs: alteraÃ§Ã£o na documentaÃ§Ã£o"
    echo "  â€¢ style: formataÃ§Ã£o, ponto e vÃ­rgula, etc"
    echo "  â€¢ refactor: refatoraÃ§Ã£o de cÃ³digo"
    echo "  â€¢ test: adiÃ§Ã£o ou correÃ§Ã£o de testes"
    echo "  â€¢ chore: manutenÃ§Ã£o geral"
    echo "  â€¢ perf: melhoria de performance"
    echo "  â€¢ ci: alteraÃ§Ãµes no CI/CD"
    echo "  â€¢ build: alteraÃ§Ãµes no build"
    echo ""
    echo -e "${BLUE}Escopos sugeridos:${NC} ${VALID_SCOPES//|/, }"
    echo ""
    echo -e "${YELLOW}Exemplos:${NC}"
    echo "  feat(auth): adicionar autenticaÃ§Ã£o por token"
    echo "  fix(database): corrigir conexÃ£o com Supabase"
    echo "  docs(readme): atualizar instruÃ§Ãµes de instalaÃ§Ã£o"
    echo "  style(app): formatar cÃ³digo com black"
    echo ""
    
    read -p "Deseja continuar com a mensagem atual? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}Edite a mensagem e tente novamente${NC}"
        exit 1
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. VALIDAÃ‡ÃƒO DE CONTEÃšDO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "ValidaÃ§Ã£o de ConteÃºdo"

# Verificar se comeÃ§a com maiÃºscula (apÃ³s o tipo:)
if echo "$SUBJECT" | grep -qE ": [a-z]"; then
    echo -e "  ${YELLOW}âš ï¸  DescriÃ§Ã£o deveria comeÃ§ar com letra minÃºscula${NC}"
    echo -e "  ${BLUE}ğŸ’¡ ConvenÃ§Ã£o: 'feat(auth): adicionar login' (nÃ£o 'Adicionar')${NC}"
fi

# Verificar se termina com ponto
if echo "$SUBJECT" | grep -q "\.$"; then
    echo -e "  ${YELLOW}âš ï¸  Evite ponto final no tÃ­tulo${NC}"
    echo -e "  ${BLUE}ğŸ’¡ O tÃ­tulo Ã© como um rÃ³tulo, nÃ£o uma frase${NC}"
fi

# Verificar palavras problemÃ¡ticas
PROBLEMATIC_WORDS="WIP|TODO|FIXME|DEBUG|TEST|TEMP|TEMPORARY"
if echo "$SUBJECT" | grep -qiE "\b(${PROBLEMATIC_WORDS})\b"; then
    echo -e "  ${RED}âŒ Mensagem contÃ©m palavras problemÃ¡ticas${NC}"
    echo -e "  ${BLUE}ğŸ’¡ Evite: ${PROBLEMATIC_WORDS//|/, }${NC}"
    echo -e "  ${YELLOW}ğŸ’¡ Esta parece ser uma mudanÃ§a temporÃ¡ria ou incompleta${NC}"
    
    read -p "Continuar mesmo assim? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Verificar verbos imperativos
GOOD_VERBS="adicionar|remover|corrigir|atualizar|implementar|refatorar|otimizar|melhorar|configurar|integrar"
BAD_VERBS="adicionado|removido|corrigido|atualizado|implementado|refatorado|otimizado|melhorado|configurado|integrado"

if echo "$DESCRIPTION" | grep -qiE "\b(${BAD_VERBS})\b"; then
    echo -e "  ${YELLOW}âš ï¸  Use verbos no imperativo${NC}"
    echo -e "  ${BLUE}ğŸ’¡ 'adicionar feature' em vez de 'adicionado feature'${NC}"
    echo -e "  ${BLUE}ğŸ’¡ 'corrigir bug' em vez de 'corrigido bug'${NC}"
fi

echo -e "  ${GREEN}âœ… ValidaÃ§Ã£o de conteÃºdo concluÃ­da${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. VALIDAÃ‡ÃƒO DE CORPO DA MENSAGEM
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "ValidaÃ§Ã£o do Corpo"

# Verificar se hÃ¡ corpo da mensagem
BODY=$(echo "$COMMIT_MSG" | tail -n +3)
HAS_BODY=false

if [ -n "$BODY" ] && [ "$BODY" != "" ]; then
    HAS_BODY=true
    echo -e "  ${GREEN}âœ… Corpo da mensagem presente${NC}"
    
    # Verificar linha em branco apÃ³s o tÃ­tulo
    SECOND_LINE=$(echo "$COMMIT_MSG" | sed -n '2p')
    if [ -n "$SECOND_LINE" ]; then
        echo -e "  ${YELLOW}âš ï¸  Deve haver linha em branco apÃ³s o tÃ­tulo${NC}"
        echo -e "  ${BLUE}ğŸ’¡ Formato: tÃ­tulo + linha vazia + corpo${NC}"
    fi
    
    # Verificar tamanho das linhas no corpo
    while IFS= read -r line; do
        if [ ${#line} -gt 72 ]; then
            echo -e "  ${YELLOW}âš ï¸  Linha no corpo muito longa (${#line} chars)${NC}"
            echo -e "  ${BLUE}ğŸ’¡ Mantenha linhas do corpo com atÃ© 72 caracteres${NC}"
            break
        fi
    done <<< "$BODY"
    
else
    echo -e "  ${BLUE}â„¹ï¸  Sem corpo da mensagem${NC}"
    
    # Sugerir corpo para mudanÃ§as complexas
    if echo "$TYPE" | grep -qE "^(feat|fix|refactor)$"; then
        echo -e "  ${BLUE}ğŸ’¡ Para mudanÃ§as importantes, considere adicionar:${NC}"
        echo "    â€¢ Contexto da mudanÃ§a"
        echo "    â€¢ RazÃ£o da mudanÃ§a"
        echo "    â€¢ Impacto esperado"
        echo "    â€¢ InstruÃ§Ãµes especiais"
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. SUGESTÃ•ES DE MELHORIA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "SugestÃµes de Melhoria"

# Analisar tipo de commit e dar sugestÃµes especÃ­ficas
case "$TYPE" in
    "feat")
        echo -e "  ${BLUE}ğŸ’¡ Nova funcionalidade:${NC}"
        echo "    â€¢ Descreva o que a feature faz"
        echo "    â€¢ Mencione se hÃ¡ breaking changes"
        echo "    â€¢ Inclua referÃªncia a issues/tickets"
        ;;
    "fix")
        echo -e "  ${BLUE}ğŸ’¡ CorreÃ§Ã£o de bug:${NC}"
        echo "    â€¢ Descreva o problema que foi corrigido"
        echo "    â€¢ Mencione como reproduzir o bug (se aplicÃ¡vel)"
        echo "    â€¢ Inclua referÃªncia ao issue/ticket"
        ;;
    "docs")
        echo -e "  ${BLUE}ğŸ’¡ DocumentaÃ§Ã£o:${NC}"
        echo "    â€¢ Especifique qual parte foi documentada"
        echo "    â€¢ Mencione se Ã© nova documentaÃ§Ã£o ou atualizaÃ§Ã£o"
        ;;
    "refactor")
        echo -e "  ${BLUE}ğŸ’¡ RefatoraÃ§Ã£o:${NC}"
        echo "    â€¢ Explique por que a refatoraÃ§Ã£o foi necessÃ¡ria"
        echo "    â€¢ Mencione se hÃ¡ mudanÃ§as de comportamento"
        echo "    â€¢ Inclua mÃ©tricas de melhoria (se aplicÃ¡vel)"
        ;;
esac

# Verificar se menciona issues
if ! echo "$COMMIT_MSG" | grep -qE "#[0-9]+|closes|fixes|resolves"; then
    echo -e "  ${BLUE}ğŸ’¡ Considere referenciar issues:${NC}"
    echo "    â€¢ #123 - para referenciar issue"
    echo "    â€¢ closes #123 - para fechar issue"
    echo "    â€¢ fixes #123 - para correÃ§Ãµes"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 7. MELHORIAS AUTOMÃTICAS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "Melhorias AutomÃ¡ticas"

IMPROVED_MSG="$COMMIT_MSG"
IMPROVEMENTS_MADE=false

# Corrigir capitalizaÃ§Ã£o comum
if echo "$SUBJECT" | grep -qE ": [A-Z]" && ! echo "$SUBJECT" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)"; then
    # Se nÃ£o segue conventional commits, nÃ£o alterar
    echo -e "  ${BLUE}â„¹ï¸  Mantendo capitalizaÃ§Ã£o original${NC}"
elif echo "$SUBJECT" | grep -qE ": [A-Z]"; then
    # Corrigir para minÃºscula apÃ³s os dois pontos
    IMPROVED_SUBJECT=$(echo "$SUBJECT" | sed -E 's/: ([A-Z])/: \l\1/')
    IMPROVED_MSG=$(echo "$COMMIT_MSG" | sed "1s/.*/$IMPROVED_SUBJECT/")
    IMPROVEMENTS_MADE=true
    echo -e "  ${GREEN}âœ… Corrigida capitalizaÃ§Ã£o: primeira letra minÃºscula${NC}"
fi

# Remover ponto final se presente
if echo "$SUBJECT" | grep -q "\.$"; then
    IMPROVED_SUBJECT=$(echo "$SUBJECT" | sed 's/\.$$//')
    IMPROVED_MSG=$(echo "$IMPROVED_MSG" | sed "1s/.*/$IMPROVED_SUBJECT/")
    IMPROVEMENTS_MADE=true
    echo -e "  ${GREEN}âœ… Removido ponto final do tÃ­tulo${NC}"
fi

# Aplicar melhorias se houver
if [ "$IMPROVEMENTS_MADE" = true ]; then
    echo -e "\n${YELLOW}ğŸ’¡ Mensagem melhorada automaticamente:${NC}"
    echo -e "${GREEN}Nova mensagem:${NC}"
    echo "$IMPROVED_MSG" | head -1
    
    read -p "Aplicar melhorias? [Y/n] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        echo "$IMPROVED_MSG" > "$COMMIT_MSG_FILE"
        echo -e "${GREEN}âœ… Melhorias aplicadas!${NC}"
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONCLUSÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "\n${GREEN}ğŸ‰ ValidaÃ§Ã£o de mensagem concluÃ­da!${NC}"
echo -e "${BLUE}ğŸ“Š Resumo:${NC}"
echo "  â€¢ Tamanho: $SUBJECT_LENGTH caracteres"
echo "  â€¢ Formato: $([ -n "$TYPE" ] && echo "Conventional ($TYPE)" || echo "Livre")"
echo "  â€¢ Escopo: $([ -n "$SCOPE" ] && echo "$SCOPE" || echo "Nenhum")"
echo "  â€¢ Corpo: $([ "$HAS_BODY" = true ] && echo "Presente" || echo "Ausente")"

exit 0
