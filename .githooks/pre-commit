#!/bin/bash
# Hook pre-commit para PetCare DBA Admin
# Este script Ã© executado antes de cada commit para garantir qualidade do cÃ³digo

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ConfiguraÃ§Ãµes
PYTHON_FILES_PATTERN=".*\.py$"
MAX_LINE_LENGTH=120
MIN_COVERAGE=80

echo -e "${BLUE}ğŸ” Executando verificaÃ§Ãµes pre-commit...${NC}"

# FunÃ§Ã£o para imprimir cabeÃ§alho de seÃ§Ã£o
print_section() {
    echo -e "\n${BLUE}â•â•â• $1 â•â•â•${NC}"
}

# FunÃ§Ã£o para verificar se comando existe
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# FunÃ§Ã£o para verificar arquivos modificados
get_modified_python_files() {
    git diff --cached --name-only --diff-filter=ACM | grep -E "${PYTHON_FILES_PATTERN}" || true
}

# Obter lista de arquivos Python modificados
PYTHON_FILES=$(get_modified_python_files)

if [ -z "$PYTHON_FILES" ]; then
    echo -e "${GREEN}âœ… Nenhum arquivo Python modificado. Prosseguindo...${NC}"
    exit 0
fi

echo -e "${YELLOW}ğŸ“ Arquivos Python modificados:${NC}"
echo "$PYTHON_FILES" | sed 's/^/  /'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. VERIFICAÃ‡ÃƒO DE SINTAXE PYTHON
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "VerificaÃ§Ã£o de Sintaxe Python"

syntax_errors=0
for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        echo -n "  Verificando $file... "
        if python3 -m py_compile "$file" 2>/dev/null; then
            echo -e "${GREEN}âœ…${NC}"
        else
            echo -e "${RED}âŒ Erro de sintaxe${NC}"
            python3 -m py_compile "$file"
            syntax_errors=$((syntax_errors + 1))
        fi
    fi
done

if [ $syntax_errors -gt 0 ]; then
    echo -e "${RED}âŒ Encontrados $syntax_errors erro(s) de sintaxe. Corrija antes de commitar.${NC}"
    exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. FORMATAÃ‡ÃƒO DE CÃ“DIGO COM BLACK
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "VerificaÃ§Ã£o de FormataÃ§Ã£o (Black)"

if command_exists black; then
    echo "  Verificando formataÃ§Ã£o com black..."
    if echo "$PYTHON_FILES" | xargs black --check --line-length=$MAX_LINE_LENGTH --quiet; then
        echo -e "  ${GREEN}âœ… CÃ³digo estÃ¡ bem formatado${NC}"
    else
        echo -e "  ${YELLOW}âš ï¸  CÃ³digo nÃ£o estÃ¡ formatado corretamente${NC}"
        echo -e "  ${BLUE}ğŸ’¡ Execute: black --line-length=$MAX_LINE_LENGTH $PYTHON_FILES${NC}"
        
        # OpÃ§Ã£o automÃ¡tica de formataÃ§Ã£o
        read -p "  Formatar automaticamente? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "$PYTHON_FILES" | xargs black --line-length=$MAX_LINE_LENGTH
            echo -e "  ${GREEN}âœ… CÃ³digo formatado automaticamente${NC}"
            echo -e "  ${YELLOW}âš ï¸  Arquivos foram modificados. Re-execute o commit.${NC}"
            exit 1
        else
            echo -e "  ${RED}âŒ Formate o cÃ³digo antes de commitar${NC}"
            exit 1
        fi
    fi
else
    echo -e "  ${YELLOW}âš ï¸  Black nÃ£o instalado. Pulando verificaÃ§Ã£o de formataÃ§Ã£o.${NC}"
    echo -e "  ${BLUE}ğŸ’¡ Instale com: pip install black${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. LINTING COM FLAKE8
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "VerificaÃ§Ã£o de Linting (Flake8)"

if command_exists flake8; then
    echo "  Executando flake8..."
    if echo "$PYTHON_FILES" | xargs flake8 --max-line-length=$MAX_LINE_LENGTH --ignore=E203,W503,E501; then
        echo -e "  ${GREEN}âœ… Nenhum problema de linting encontrado${NC}"
    else
        echo -e "  ${RED}âŒ Problemas de linting encontrados. Corrija antes de commitar.${NC}"
        exit 1
    fi
else
    echo -e "  ${YELLOW}âš ï¸  Flake8 nÃ£o instalado. Pulando verificaÃ§Ã£o de linting.${NC}"
    echo -e "  ${BLUE}ğŸ’¡ Instale com: pip install flake8${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. VERIFICAÃ‡ÃƒO DE SEGURANÃ‡A COM BANDIT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "VerificaÃ§Ã£o de SeguranÃ§a (Bandit)"

if command_exists bandit; then
    echo "  Executando verificaÃ§Ã£o de seguranÃ§a..."
    if echo "$PYTHON_FILES" | xargs bandit -ll -q; then
        echo -e "  ${GREEN}âœ… Nenhum problema de seguranÃ§a encontrado${NC}"
    else
        echo -e "  ${YELLOW}âš ï¸  PossÃ­veis problemas de seguranÃ§a encontrados${NC}"
        echo -e "  ${BLUE}ğŸ’¡ Revise os problemas reportados pelo bandit${NC}"
        
        # NÃ£o bloquear commit por problemas de seguranÃ§a de baixa prioridade
        read -p "  Continuar mesmo assim? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
else
    echo -e "  ${YELLOW}âš ï¸  Bandit nÃ£o instalado. Pulando verificaÃ§Ã£o de seguranÃ§a.${NC}"
    echo -e "  ${BLUE}ğŸ’¡ Instale com: pip install bandit${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. VERIFICAÃ‡ÃƒO DE IMPORTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "VerificaÃ§Ã£o de Imports"

echo "  Verificando imports nÃ£o utilizados..."
import_issues=0

for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        # Verificar se hÃ¡ imports obviamente nÃ£o utilizados
        unused_imports=$(grep -n "^import\|^from.*import" "$file" | head -5 || true)
        if [ -n "$unused_imports" ]; then
            echo "    Imports em $file:"
            echo "$unused_imports" | sed 's/^/      /'
        fi
    fi
done

echo -e "  ${GREEN}âœ… VerificaÃ§Ã£o de imports concluÃ­da${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. VERIFICAÃ‡ÃƒO DE ARQUIVOS SENSÃVEIS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "VerificaÃ§Ã£o de Arquivos SensÃ­veis"

# Lista de padrÃµes que nÃ£o devem ser commitados
SENSITIVE_PATTERNS=(
    "password\s*="
    "secret\s*="
    "api_key\s*="
    "token\s*="
    "\.env$"
    "secrets\.toml$"
    "\.key$"
    "\.pem$"
)

sensitive_found=0
for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    matches=$(git diff --cached --name-only | grep -E "$pattern" || true)
    if [ -n "$matches" ]; then
        echo -e "  ${RED}âŒ Arquivo sensÃ­vel detectado: $matches${NC}"
        sensitive_found=1
    fi
    
    # Verificar conteÃºdo dos arquivos por padrÃµes sensÃ­veis
    content_matches=$(git diff --cached | grep -E "$pattern" || true)
    if [ -n "$content_matches" ]; then
        echo -e "  ${RED}âŒ ConteÃºdo sensÃ­vel detectado:${NC}"
        echo "$content_matches" | sed 's/^/    /'
        sensitive_found=1
    fi
done

if [ $sensitive_found -eq 1 ]; then
    echo -e "  ${RED}âŒ Arquivos ou conteÃºdo sensÃ­vel detectado. Remova antes de commitar.${NC}"
    exit 1
else
    echo -e "  ${GREEN}âœ… Nenhum arquivo sensÃ­vel detectado${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 7. VERIFICAÃ‡ÃƒO DE TAMANHO DE ARQUIVOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "VerificaÃ§Ã£o de Tamanho de Arquivos"

MAX_FILE_SIZE=$((5 * 1024 * 1024)) # 5MB
large_files=0

for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt $MAX_FILE_SIZE ]; then
            echo -e "  ${RED}âŒ Arquivo muito grande: $file ($(($size / 1024 / 1024))MB)${NC}"
            large_files=1
        fi
    fi
done

if [ $large_files -eq 1 ]; then
    echo -e "  ${RED}âŒ Arquivos muito grandes detectados. Use Git LFS ou remova.${NC}"
    exit 1
else
    echo -e "  ${GREEN}âœ… Tamanhos de arquivo OK${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 8. VERIFICAÃ‡ÃƒO DE MENSAGEM DE COMMIT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
print_section "Dicas para Mensagem de Commit"

echo -e "  ${BLUE}ğŸ’¡ Lembre-se de usar uma mensagem de commit descritiva:${NC}"
echo "    â€¢ Use o formato: tipo(escopo): descriÃ§Ã£o"
echo "    â€¢ Tipos: feat, fix, docs, style, refactor, test, chore"
echo "    â€¢ Exemplo: feat(database): adicionar suporte para backup automÃ¡tico"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONCLUSÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "\n${GREEN}ğŸ‰ Todas as verificaÃ§Ãµes passaram! Commit liberado.${NC}"
echo -e "${BLUE}ğŸ“Š Resumo:${NC}"
echo "  â€¢ Arquivos verificados: $(echo "$PYTHON_FILES" | wc -l)"
echo "  â€¢ Sintaxe: âœ…"
echo "  â€¢ FormataÃ§Ã£o: âœ…"
echo "  â€¢ Linting: âœ…"
echo "  â€¢ SeguranÃ§a: âœ…"
echo "  â€¢ Arquivos sensÃ­veis: âœ…"
echo "  â€¢ Tamanho de arquivos: âœ…"

exit 0
