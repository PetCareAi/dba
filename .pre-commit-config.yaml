# ConfiguraÃ§Ã£o do pre-commit para o projeto PetCare DBA Admin
# Para instalar: pip install pre-commit && pre-commit install

repos:
  # Hooks bÃ¡sicos
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # VerificaÃ§Ãµes bÃ¡sicas de arquivos
      - id: trailing-whitespace
        name: "ğŸ§¹ Removendo espaÃ§os em branco no final das linhas"
      - id: end-of-file-fixer
        name: "ğŸ“ Corrigindo final de arquivo"
      - id: check-yaml
        name: "ğŸ“‹ Verificando sintaxe YAML"
      - id: check-toml
        name: "âš™ï¸ Verificando sintaxe TOML"
      - id: check-json
        name: "ğŸ“Š Verificando sintaxe JSON"
      - id: check-xml
        name: "ğŸ·ï¸ Verificando sintaxe XML"
      
      # VerificaÃ§Ãµes de merge e estrutura
      - id: check-merge-conflict
        name: "ğŸ”€ Verificando conflitos de merge"
      - id: check-added-large-files
        name: "ğŸ“¦ Verificando arquivos grandes"
        args: ['--maxkb=1024']  # Limite de 1MB
      - id: check-case-conflict
        name: "ğŸ“ Verificando conflitos de case em nomes"
      
      # VerificaÃ§Ãµes especÃ­ficas de Python
      - id: check-ast
        name: "ğŸ Verificando sintaxe Python (AST)"
      - id: check-builtin-literals
        name: "ğŸ”¤ Verificando literais built-in Python"
      - id: check-docstring-first
        name: "ğŸ“š Verificando posiÃ§Ã£o de docstrings"
      - id: debug-statements
        name: "ğŸ› Verificando statements de debug"
      - id: name-tests-test
        name: "ğŸ§ª Verificando nomenclatura de testes"
        args: ['--pytest-test-first']
      
      # VerificaÃ§Ãµes de seguranÃ§a bÃ¡sicas
      - id: detect-private-key
        name: "ğŸ” Detectando chaves privadas"
      - id: detect-aws-credentials
        name: "â˜ï¸ Detectando credenciais AWS"

  # FormataÃ§Ã£o de cÃ³digo Python
  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black
        name: "âš« Formatando cÃ³digo Python com Black"
        language_version: python3
        args: [
          "--line-length=120",
          "--target-version=py39",
          "--target-version=py310",
          "--target-version=py311"
        ]

  # OrganizaÃ§Ã£o de imports
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: "ğŸ“¦ Organizando imports com isort"
        args: [
          "--profile=black",
          "--line-length=120",
          "--multi-line=3",
          "--trailing-comma",
          "--force-grid-wrap=0",
          "--combine-as",
          "--use-parentheses"
        ]

  # Linting Python
  - repo: https://github.com/pycqa/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        name: "ğŸ” Analisando cÃ³digo Python com Flake8"
        args: [
          "--max-line-length=120",
          "--extend-ignore=E203,E501,W503,F401",
          "--max-complexity=10"
        ]
        additional_dependencies:
          - flake8-docstrings
          - flake8-bugbear
          - flake8-comprehensions
          - flake8-simplify

  # VerificaÃ§Ã£o de tipos com mypy
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        name: "ğŸ¯ Verificando tipos com MyPy"
        args: [
          "--ignore-missing-imports",
          "--disallow-untyped-defs",
          "--no-implicit-optional"
        ]
        additional_dependencies:
          - types-requests
          - types-PyYAML
          - types-python-dateutil

  # VerificaÃ§Ãµes de seguranÃ§a
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        name: "ğŸ›¡ï¸ Verificando seguranÃ§a com Bandit"
        args: [
          "-r",
          "--format=custom",
          "--skip=B101,B601"  # Skip assert_used e shell=True warnings
        ]
        exclude: ^(tests/|test_)

  # VerificaÃ§Ã£o de dependÃªncias de seguranÃ§a
  - repo: https://github.com/Lucas-C/pre-commit-hooks-safety
    rev: v1.3.2
    hooks:
      - id: python-safety-dependencies-check
        name: "ğŸ”’ Verificando vulnerabilidades em dependÃªncias"

  # FormataÃ§Ã£o de arquivos YAML
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        name: "âœ¨ Formatando YAML/JSON com Prettier"
        types_or: [yaml, json]
        args: ["--tab-width=2", "--print-width=100"]

  # VerificaÃ§Ã£o de commits convencionais
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v3.0.0
    hooks:
      - id: conventional-pre-commit
        name: "ğŸ“ Verificando formato de commit convencional"
        stages: [commit-msg]

  # VerificaÃ§Ã£o de secrets/credenciais
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        name: "ğŸ•µï¸ Detectando secrets/credenciais"
        args: [
          '--baseline', '.secrets.baseline',
          '--force-use-all-plugins'
        ]
        exclude: |
          (?x)^(
            .*\.git/.*|
            .*\.streamlit/secrets\.toml|
            .*\.env.*|
            .*test.*\.py|
            .*mock.*\.py
          )$

  # Hooks especÃ­ficos para Python/Streamlit
  - repo: local
    hooks:
      # VerificaÃ§Ã£o de imports de Streamlit
      - id: streamlit-imports
        name: "ğŸ“± Verificando imports do Streamlit"
        entry: python -c "
import re, sys;
files = [f for f in sys.argv[1:] if f.endswith('.py')];
for f in files:
    with open(f) as file:
        content = file.read();
        if 'import streamlit' in content and 'streamlit as st' not in content:
            print(f'{f}: Use \"import streamlit as st\" para consistÃªncia');
            sys.exit(1)
"
        language: system
        files: \.py$

      # VerificaÃ§Ã£o de configuraÃ§Ãµes sensÃ­veis
      - id: check-secrets-config
        name: "ğŸ” Verificando configuraÃ§Ãµes sensÃ­veis"
        entry: python -c "
import sys, re;
for f in sys.argv[1:]:
    if f.endswith('.py'):
        with open(f) as file:
            content = file.read();
            if re.search(r'(password|secret|key)\s*=\s*[\"\\'][^\"\\'\s][^\"\\';]+[\"\\']', content, re.I):
                print(f'{f}: PossÃ­vel hardcoded secret detectado');
                sys.exit(1)
"
        language: system
        files: \.py$

      # VerificaÃ§Ã£o de TODOs em produÃ§Ã£o
      - id: check-todos
        name: "ğŸ“‹ Verificando TODOs nÃ£o resolvidos"
        entry: python -c "
import sys;
for f in sys.argv[1:]:
    if f.endswith('.py'):
        with open(f) as file:
            lines = file.readlines();
            for i, line in enumerate(lines):
                if 'TODO:' in line.upper() and 'FIXME' in line.upper():
                    print(f'{f}:{i+1}: TODO/FIXME nÃ£o resolvido: {line.strip()}');
                    sys.exit(1)
"
        language: system
        files: \.py$

      # VerificaÃ§Ã£o de estrutura de docstrings
      - id: docstring-format
        name: "ğŸ“– Verificando formato de docstrings"
        entry: python -c "
import ast, sys;
for f in sys.argv[1:]:
    if f.endswith('.py'):
        try:
            with open(f) as file:
                tree = ast.parse(file.read());
                for node in ast.walk(tree):
                    if isinstance(node, (ast.FunctionDef, ast.ClassDef)):
                        if node.body and isinstance(node.body[0], ast.Expr) and isinstance(node.body[0].value, ast.Str):
                            docstring = node.body[0].value.s;
                            if not docstring.startswith('\"\"\"') or not docstring.endswith('\"\"\"'):
                                print(f'{f}: FunÃ§Ã£o/classe {node.name} tem docstring mal formatada');
        except:
            pass
"
        language: system
        files: \.py$

# ConfiguraÃ§Ã£o global
default_language_version:
  python: python3.11

# EstÃ¡gios de execuÃ§Ã£o
default_stages: [commit, push]

# ConfiguraÃ§Ãµes especÃ­ficas por estÃ¡gio
ci:
  autofix_commit_msg: |
    [pre-commit.ci] correÃ§Ãµes automÃ¡ticas de hooks

    [skip ci]
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] atualizaÃ§Ãµes automÃ¡ticas de hooks'
  autoupdate_schedule: weekly
  skip: []
  submodules: false
